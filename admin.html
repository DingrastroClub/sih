<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIH 2025 Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html {
            background-color: #000000;
        }
        body {
            font-family: 'Inter', sans-serif;
            color: #e5e7eb;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: relative;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: absolute;
            top: -30%;
            left: 50%;
            transform: translateX(-50%);
            width: 120%;
            height: 120%;
            background: radial-gradient(circle at center, rgba(30, 144, 255, 0.25) 0%, rgba(0, 0, 0, 0) 40%);
            z-index: -1;
            pointer-events: none;
        }
        .applicant-card {
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(56, 189, 248, 0.3);
            border-radius: 1.5rem;
            transition: all 0.3s ease;
        }
        .applicant-card:hover {
            border-color: rgba(56, 189, 248, 0.6);
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.2);
        }
        .status-btn {
            transition: all 0.2s ease-in-out;
        }
        .status-btn:hover {
            transform: scale(1.05);
        }
        .status-btn.active {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }
        .question-title {
             color: #94a3b8;
        }
        .answer-text {
            color: #e5e7eb;
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <div class="w-full max-w-7xl mx-auto">
        <div class="text-center mb-10">
            <h1 class="text-3xl sm:text-5xl font-bold text-white tracking-tight">SIH 2025 Applicant Responses</h1>
            <p class="mt-4 text-lg text-gray-400">Review and update applicant statuses below.</p>
        </div>
        
        <div id="loading-indicator" class="text-center">
            <p class="text-lg text-gray-400">Loading applications...</p>
        </div>

        <div id="no-applicants" class="text-center hidden">
            <p class="text-lg text-gray-400">No applications have been submitted yet.</p>
        </div>

        <div id="applicants-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            <!-- Applicant cards will be injected here by JavaScript -->
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="fixed inset-0 hidden bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
      <div class="bg-red-900/50 backdrop-blur-lg rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center border border-red-400/40">
        <div class="mx-auto mb-4 w-16 h-16 flex items-center justify-center rounded-full bg-red-500/30 text-red-300 text-3xl">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        </div>
        <h2 class="text-xl font-semibold text-white mb-2">Are you sure?</h2>
        <p class="text-gray-200">
          Deleting this application is permanent and cannot be undone.
        </p>
        <div class="mt-6 flex justify-center space-x-4">
            <button id="cancel-delete-btn" class="px-5 py-2 rounded-full bg-white/20 hover:bg-white/30 text-white backdrop-blur-md border border-white/30 transition">
              Cancel
            </button>
            <button id="confirm-delete-btn" class="px-5 py-2 rounded-full bg-red-600 hover:bg-red-700 text-white backdrop-blur-md border border-red-500 transition">
              Confirm Delete
            </button>
        </div>
      </div>
    </div>

<script type="module">
    // --- Modular Firebase SDK Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // --- User's Firebase Configuration ---
    const firebaseConfig = {
        apiKey: "AIzaSyB4eoofAdY4DrW-VKvfGJl5aNv2hoCTn4c",
        authDomain: "iist-fd6e8.firebaseapp.com",
        databaseURL: "https://iist-fd6e8-default-rtdb.firebaseio.com",
        projectId: "iist-fd6e8",
        storageBucket: "iist-fd6e8.appspot.com",
        messagingSenderId: "692699808449",
        appId: "1:692699808449:web:120c8941a940d071f24a40",
        measurementId: "G-GPFG8LWF2H"
    };

    // --- Environment Variables & Constants ---
    // This logic now perfectly matches the index.html file.
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-sih-app';
    // FIX: The `artifacts/` prefix was missing, causing the admin panel to look in the wrong place.
    const basePath = `artifacts/${appId}/public/data/sih_2025_applicants`;
    
    // --- Initialize Firebase ---
    let db, auth;
    try {
        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        auth = getAuth(app);
        console.log("Firebase initialized for Admin Panel.");
    } catch (e) {
        console.error("Error initializing Firebase:", e);
        document.body.innerHTML = '<div style="color: red; text-align: center; padding: 50px;">Could not connect to the database.</div>';
    }

    // --- Authentication ---
    if (auth) {
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Admin user is signed in:", user.uid);
                listenForApplications();
            } else {
                 try {
                     await signInAnonymously(auth);
                 } catch(error) {
                     console.error("Anonymous sign-in failed:", error);
                 }
            }
        });
    }

    const applicantsContainer = document.getElementById('applicants-container');
    const loadingIndicator = document.getElementById('loading-indicator');
    const noApplicantsMessage = document.getElementById('no-applicants');
    const deleteModal = document.getElementById('delete-confirm-modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    let docIdToDelete = null;

    function getStatusBadgeClass(status) {
        switch (status) {
            case 'Accepted': return 'bg-green-500/30 text-green-300';
            case 'Rejected': return 'bg-red-500/30 text-red-300';
            default: return 'bg-yellow-500/30 text-yellow-300';
        }
    }
    
    function showDeleteConfirmation(docId) {
        docIdToDelete = docId;
        deleteModal.classList.remove('hidden');
    }

    async function deleteApplicant() {
        if (!docIdToDelete) return;
        try {
            const applicantRef = ref(db, `${basePath}/${docIdToDelete}`);
            await remove(applicantRef);
            console.log(`Successfully deleted applicant ${docIdToDelete}`);
        } catch (error) {
             console.error("Error deleting applicant: ", error);
             alert("Failed to delete applicant. Please check the console for errors.");
        } finally {
            deleteModal.classList.add('hidden');
            docIdToDelete = null;
        }
    }

    confirmDeleteBtn.addEventListener('click', deleteApplicant);
    cancelDeleteBtn.addEventListener('click', () => {
        deleteModal.classList.add('hidden');
        docIdToDelete = null;
    });

    async function updateApplicantStatus(docId, newStatus) {
        try {
            const applicantRef = ref(db, `${basePath}/${docId}`);
            await update(applicantRef, {
                status: newStatus
            });
            console.log(`Successfully updated status for ${docId} to ${newStatus}`);
        } catch (error) {
            console.error("Error updating status: ", error);
            alert("Failed to update status. Please check the console for errors.");
        }
    }
    
    function createApplicantCard(applicantData, docId) {
        const status = applicantData.status || 'Under Review';
        const card = document.createElement('div');
        card.className = 'applicant-card p-6 flex flex-col space-y-4';
        
        const details = {
            'Name': applicantData.name,
            'Email': `<a href="mailto:${applicantData.email}" class="text-sky-400 hover:underline">${applicantData.email}</a>`,
            'Phone': `<a href="tel:${applicantData.phone}" class="text-sky-400 hover:underline">${applicantData.phone}</a>`,
            'Portfolio': `<a href="${applicantData.github}" target="_blank" rel="noopener noreferrer" class="text-sky-400 hover:underline">View Profile</a>`,
            'Gender': applicantData.gender,
            'Primary Role': applicantData.role,
            'Languages': Array.isArray(applicantData.languages) ? applicantData.languages.join(', ') : '',
            'Hardware Skills': Array.isArray(applicantData.hardware_skills) ? applicantData.hardware_skills.join(', ') : '',
            'DevOps Skills': Array.isArray(applicantData.devops_skills) ? applicantData.devops_skills.join(', ') : '',
            'Creative Skills': Array.isArray(applicantData.creative_skills) ? applicantData.creative_skills.join(', ') : '',
            'Hackathon Experience': `${applicantData.hackathon_experience}/10`,
            'Problem Solving': `${applicantData.problem_solving}/10`,
            'Domain Interests': applicantData.ideas,
            'Project Scoping': applicantData.project_mgmt,
            'Significant Contribution': applicantData.contribution,
            'Troubleshooting': applicantData.troubleshooting,
            'Conflict Resolution': applicantData.conflict_resolution,
            'Handling Pressure': applicantData.pressure_handling,
        };

        let detailsHtml = '';
        for(const [key, value] of Object.entries(details)) {
            if(value) {
                detailsHtml += `
                    <div>
                        <p class="text-sm font-medium question-title">${key}</p>
                        <p class="text-base answer-text break-words">${value}</p>
                    </div>
                `;
            }
        }

        card.innerHTML = `
            <div class="flex justify-between items-start">
                <h2 class="text-xl font-bold text-white">${applicantData.name}</h2>
                <span class="text-xs font-semibold px-2.5 py-1 rounded-full ${getStatusBadgeClass(status)}">${status}</span>
            </div>
            <div class="space-y-3 overflow-auto pr-2" style="max-height: 400px;">${detailsHtml}</div>
            <div class="pt-4 border-t border-white/10 mt-auto">
                <p class="text-sm font-medium text-gray-400 mb-2">Update Status:</p>
                <div class="flex items-center justify-center space-x-3">
                    <button data-status="Accepted" class="status-btn px-4 py-2 text-sm rounded-full bg-green-500/80 hover:bg-green-500 text-white font-semibold ${status === 'Accepted' ? 'active ring-2 ring-white' : ''}">Accept</button>
                    <button data-status="Rejected" class="status-btn px-4 py-2 text-sm rounded-full bg-red-500/80 hover:bg-red-500 text-white font-semibold ${status === 'Rejected' ? 'active ring-2 ring-white' : ''}">Reject</button>
                    <button data-status="Under Review" class="status-btn px-4 py-2 text-sm rounded-full bg-yellow-500/80 hover:bg-yellow-500 text-white font-semibold ${status === 'Under Review' ? 'active ring-2 ring-white' : ''}">Reviewing</button>
                </div>
                <div class="mt-4 text-center">
                    <button class="delete-btn text-sm text-red-400 hover:text-red-300 hover:underline transition-colors">Delete Application</button>
                </div>
            </div>
        `;

        card.querySelectorAll('.status-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const newStatus = e.target.dataset.status;
                updateApplicantStatus(docId, newStatus);
            });
        });

        card.querySelector('.delete-btn').addEventListener('click', () => {
            showDeleteConfirmation(docId);
        });

        return card;
    }

    function listenForApplications() {
        const dbRef = ref(db, basePath);
        
        onValue(dbRef, (snapshot) => {
            loadingIndicator.classList.add('hidden');
            applicantsContainer.innerHTML = ''; 
            
            if (snapshot.exists()) {
                noApplicantsMessage.classList.add('hidden');
                const applicants = snapshot.val();
                for (const docId in applicants) {
                    const applicantData = applicants[docId];
                    const applicantCard = createApplicantCard(applicantData, docId);
                    applicantsContainer.appendChild(applicantCard);
                }
            } else {
                noApplicantsMessage.classList.remove('hidden');
            }
        }, (error) => {
            console.error("Error fetching applications: ", error);
            loadingIndicator.innerText = "Error loading applications. Please check console.";
        });
    }

</script>
</body>
</html>

